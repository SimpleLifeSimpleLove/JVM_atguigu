# 第12章 执行引擎

## 1 执行引擎概述

<img src="images/227.png" alt="img" style="zoom:67%;" />

* 执行引擎是Java虚拟机核心的组成部分之一。
* “虚拟机”是相对于“物理机”的概念，这两种机器都有代码执行能力，其区别是物理机的执行引擎是直接建立在处理器、缓存、指令集和操作系统层面上的，而<font color=red>**虚拟机的执行引擎则是由软件自行实现的**</font>，因此可以不受物理条件限制地定制指令集和执行引擎的体系结构，<font color=red>**能够执行那些不被硬件直接支持的指令集格式**</font>。

---

* JVM的主要任务是负责<font color=red>**装载字节码到其内部**</font>，但字节码并不能直接运行在操作系统之上，因为字节码指令并非等价于本地机器指令，它内部包含的仅仅只是一些能够被JVM所识别的字节码指令、符号表，以及其他辅助信息。
* 那么，如果想要让一个Java程序运行起来，执行引擎（Execution Engine）的任务就是<font color=red>**将字节码指令解释/编译为对应平台上的本地机器指令才可以**</font>。简单来说，JVM的执行引擎充当了将高级语言翻译为机器语言的译者。

---

<img src="images/228.png" alt="img" style="zoom:67%;" />

* 外观上来看，所有的Java虚拟机的执行引擎、输出都是一致的：输入的是字节码二进制流，处理过程是字节码解析执行的等效过程，输出的是执行结果。

## 2 Java代码编译和执行过程

<img src="images/229.png" alt="img" style="zoom:67%;" />

* 大部分的程序代码转换成物理机的目标代码或虚拟机能执行的指令集之前，都需要经过上图的各个步骤。

---

* Java代码编译是由Java源码编译器来完成，流程图如下所示（javac，前端编译）：

  <img src="images/230.png" alt="img" style="zoom:67%;" />

* Java字节码的执行是由JVM执行引擎来完成，流程图如下所示：

  <img src="images/231.png" alt="img" style="zoom:67%;" />

---

* **问题：什么是解释器（Interpreter），什么是JIT编译器？**
  * 解释器：当Java虚拟机启动时会根据预定义的规范<font color=blue>**对字节码采用逐行解释的方式执行**</font>，将每条字节码文件中的内容“翻译”为对应平台的本地机器指令执行。
  * JIT（Just In Time Compiler）编译器：就是虚拟机将源代码直接编译（后端编译）成和本地机器相关的机器语言。
* **问题：为什么说Java是半编译半解释型语言？**
  * JDK1.0时代，将Java语言定位为“解释执行”还是比较准确的。再后来，Java也发展处可以直接生成本地代码的编译器。
  * 现在JVM在执行Java代码的时候，通常都会将解释执行与编译执行两者结合起来进行。

## 3 机器码、指令、汇编语言

<img src="images/232.png" alt="img" style="zoom:67%;" />

---

* 机器码
  * 各种用二进制编码方式表示的指令，叫做<font color=blue>**机器指令码**</font>。开始，人们就用它编写程序，这就是机器语言。
  * 机器语言虽然能够被计算机理解和接收，但和人们的语言差别太大，不容易被人们理解和记忆，并且用它编程容易出差错。
  * 用它编写的程序已经输入计算机，CPU直接读取运行，因此和其他语言编的程序相比，执行速度最快。
  * 机器指令与CPU密切相关，所以不同种类的CPU锁对应的机器指令也就不同。
* 指令
  * 由于机器码是由0和1组成的二进制序列，可读性是在太差，于是人们发明了指令。
  * 指令就是把机器码中特定的0和1序列，简化成对应的指令（一般为英文简写，如mov，inc等），可读性稍好。
  * 由于不同的硬件平台，执行同一个操作，对应的机器码可能不同，所以不同的硬件平台的同一种指令（比如mov），对应的机器码也可能不同。
* 指令集
  * 不同的硬件平台，各自支持的指令，是由差别的。因此每个平台所支持的指令，称之为对应平台的指令集。
  * 如常见的
    * x86指令集，对应的是x86架构的平台
    * ARM指令集，对应的是ARM架构的平台

---

* 汇编语言
  * 由于指令的可读性还是太差，于是人们又发明了汇编语言。
  * 在汇编语言中，用<font color=blue>**助记符**</font>（Mnemonics）代替<font color=blue>**机器指令的操作码**</font>，用<font color=blue>**地址符号（Symbol）或标号（Label）**</font>代替<font color=blue>**指令或操作数的地址**</font>。
  * 在不同的硬件平台，汇编语言对应着不同的机器语言指令集，通过汇编过程转换成机器指令。
    * 由于计算机只认识指令码，所以用<font color=blue>**汇编语言编写的程序还必须翻译成机器指令码**</font>，计算机才能识别和执行。

---

* 高级语言
  * 为了使计算机用户编程更容易些，后来就出现了各种高级语言，高级语言比机器语言、汇编语言<font color=blue>**更接近人的语言**</font>。
  * 当计算机执行高级语言编写的程序时，<font color=blue>**仍然需要把程序解释和编译成机器的指令码**</font>。完成这个过程的程序就叫做解释程序或编译程序。

---

<img src="images/233.png" alt="img" style="zoom:67%;" />

---

* 字节码
  * 字节码是一种<font color=blue>**中间状态（中间码）的二进制代码（文件）**</font>，它比机器码更抽象，需要直译器转译才能成为机器码
  * 字节码主要为了实现特定软件运行和软件环境、<font color=blue>**与硬件环境无关**</font>。
  * 字节码的实现方式是通过编译器和虚拟机器。编译器将源码编译成字节码，特定平台上的虚拟机将字节码转译为可以直接执行的指令。
    * 字节码的典型应用为Java bytecode。

---

<img src="images/234.png" alt="img" style="zoom:67%;" />

## 4 解释器

113

## 5 JIT编译器